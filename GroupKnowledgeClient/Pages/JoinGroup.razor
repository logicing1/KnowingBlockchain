@page "/join/{contract}"
@layout MainLayout

@inject NavigationManager navigation;
@inject ISnackbar snackbar;
@inject IGroupState groupState;


<MudContainer Class="d-flex justify-center align-center">
    <MudPaper Elevation="5" Class="pa-5" Style="text-align:center">
        <MudText Typo="Typo.h5" Class="mt-2">Join Group:</MudText>
        <MudText Typo="Typo.h6" Class="mt-a">@Group.Name</MudText>
        <MudNumericField Variant="Variant.Outlined" Class="mt-2" T="ulong" Label="Transfer Amount" Min="@Group.MembershipFee" @bind-Value="TransferAmount" />
        <MudFab Icon="@Icons.Material.Filled.GroupRemove" Label="Join" Size="Size.Medium" Class="mt-6 align-self-center" Color="Color.Primary" @onclick="Join" />
    </MudPaper>
</MudContainer>

@code {

    [Parameter]
    public string Contract { get; set; } = string.Empty;

    private Group Group { get; set; } = Group.Empty;

    private ulong TransferAmount { get; set; } = 0;

    protected override async Task OnParametersSetAsync()
    {
        var connected = groupState.Connected.TryGetValue(Contract, out var group);
        if (connected && group != null)
        {
            Group = group;
            await Group.LoadMembershipFee();
            TransferAmount = group.MembershipFee;
        }
        else
        {
            snackbar.Add("The group is not connected", Severity.Error);
        }
    }

    private async Task Join()
    {
        var success = await Group.Join(TransferAmount);
        if (success)
        {
            snackbar.Add("Joined Group Successfully", Severity.Success);
            navigation.NavigateTo($"/questions/{Group.Address}");
        }
        else
        {
            snackbar.Add("Transaction to join group failed", Severity.Error);
        }
    }


}